trigger:
  branches:
    include:
      - main

parameters:
  - name: appName
    type: string
    default: 'AzdoTools'
  - name: environmentName
    type: string
    default: 'dev'
  - name: location
    type: string
    default: 'centralus'

stages:
- stage: DeployInfra
  displayName: 'ğŸ§± Provision Infra via Bicep'
  jobs:
  - job: DeployEnvironment
    displayName: 'Deploy Environment'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: 'HolyCheese-ServiceConnection'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "ğŸŒ Deploying subscription-level infra for ${{ parameters.appName }}-${{ parameters.environmentName }}"
          az deployment sub create \
            --location ${{ parameters.location }} \
            --template-file infra/deploy-environment.bicep \
            --parameters appName=${{ parameters.appName }} environmentName=${{ parameters.environmentName }} location=${{ parameters.location }}

- stage: BuildAndDeployApp
  displayName: 'ğŸš€ Build, Test, Deploy'
  dependsOn: DeployInfra
  jobs:
  - job: BuildTestDeploy
    displayName: 'Compile & Publish Azure Function'
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x.x'

    - script: dotnet restore
      displayName: 'ğŸ“¦ Restore'

    - script: dotnet build --configuration Release
      displayName: 'ğŸ—ï¸ Build'

    - script: dotnet test --configuration Release --no-build
      displayName: 'ğŸ§ª Test'

    - script: dotnet publish HolyCheeseAzdoTools.csproj -c Release -o $(Build.ArtifactStagingDirectory)/publish
      displayName: 'ğŸ“¤ Publish Project'

    - task: AzureFunctionApp@1
      inputs:
        azureSubscription: 'HolyCheese-ServiceConnection'
        appType: functionApp
        appName: '${{ parameters.appName }}-${{ parameters.environmentName }}'
        package: '$(Build.ArtifactStagingDirectory)/publish'
