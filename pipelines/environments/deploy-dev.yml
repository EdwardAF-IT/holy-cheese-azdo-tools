parameters:
  - name: version
    type: string
  - name: branch
    type: string
  - name: commit
    type: string
  - name: environment
    type: string
  - name: notes
    type: string
    default: ''

steps:
- task: PowerShell@2
  displayName: 'Generate Manifest File'
  continueOnError: false
  inputs:
    targetType: 'inline'
    script: |
      $manifest = @{
        version      = "${{ parameters.version }}"
        sourceBranch = "${{ parameters.branch }}"
        commit       = "${{ parameters.commit }}"
        deployedTo   = "${{ parameters.environment }}"
        deployedAt   = (Get-Date).ToString("o")
        notes        = "${{ parameters.notes }}"
      }

      $json = $manifest | ConvertTo-Json -Depth 3
      $fileName = [string]::Format("manifest-{0}.json", "${{ parameters.version }}")
      $outputPath = Join-Path "$(Build.ArtifactStagingDirectory)" $fileName

      $json | Set-Content -Path $outputPath -Encoding UTF8
      Write-Host [string]::Format("âœ… Manifest written to {0}", $outputPath)

- publish: $(Build.ArtifactStagingDirectory)
  artifact: manifest
