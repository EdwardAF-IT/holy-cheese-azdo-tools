# pipelines/templates/manifest-write.yml
parameters:
  - name: manifestPath
    type: string
    default: '$(Pipeline.Workspace)/manifest/manifest.json'
  - name: artifactPath
    type: string
    default: '$(Pipeline.Workspace)/functionapp/drop.zip'
  - name: version
    type: string
    default: '$(version)'
  - name: notes
    type: string
    default: '$(notes)'
  - name: branch
    type: string
    default: '$(branch)'
  - name: commit
    type: string
    default: '$(commit)'
  - name: environment
    type: string
    default: '$(environment)'

job: WriteManifest
displayName: 'Write Manifest File'
pool:
  vmImage: 'windows-latest'
steps:
  - checkout: self

  - task: PowerShell@2
    displayName: 'Write Manifest JSON'
    inputs:
      targetType: 'inline'
      script: |
        $manifest = @{
          version      = "${{ parameters.version }}"
          notes        = "${{ parameters.notes }}"
          branch       = "${{ parameters.branch }}"
          commit       = "${{ parameters.commit }}"
          environment  = "${{ parameters.environment }}"
          artifactPath = "${{ parameters.artifactPath }}"
        }

        $json = $manifest | ConvertTo-Json -Depth 3
        $json = $json -replace '[^\u0000-\u007F]', ''  # Strip Unicode
        $path = "${{ parameters.manifestPath }}"
        New-Item -ItemType Directory -Path (Split-Path $path) -Force | Out-Null
        $json | Out-File -FilePath $path -Encoding UTF8

        Write-Host "Manifest written to $path"
