parameters:
  - name: version
    type: string

steps:
- download: current
  artifact: manifest

- task: PowerShell@2
  displayName: 'Read Manifest File'
  inputs:
    targetType: 'inline'
    script: |
      $fileName = "manifest-${{ parameters.version }}.json"
      $path = "$(Pipeline.Workspace)/manifest/$fileName"

      if (!(Test-Path $path)) {
        Write-Error "❌ Manifest file not found: $path"
        exit 1
      }

      $manifest = Get-Content $path | ConvertFrom-Json

      Write-Host "✅ Manifest loaded: $fileName"
      Write-Host "Version: $($manifest.version)"
      Write-Host "Branch: $($manifest.sourceBranch)"
      Write-Host "Commit: $($manifest.commit)"
      Write-Host "Environment: $($manifest.deployedTo)"
      Write-Host "Timestamp: $($manifest.deployedAt)"
      Write-Host "Notes: $($manifest.notes)"

      Write-Host "##vso[task.setvariable variable=manifestBranch]$($manifest.sourceBranch)"
      Write-Host "##vso[task.setvariable variable=manifestCommit]$($manifest.commit)"
      Write-Host "##vso[task.setvariable variable=manifestEnv]$($manifest.deployedTo)"
